---
import Layout from "../layouts/Layout.astro";
import Navigation from "../components/Navigation.astro";
import Footer from "../components/Footer.astro";
import NotFoundHero from "../components/NotFoundHero.astro";
import { getCollection } from "astro:content";

// Recupera tutti gli articoli
const allArticles = await getCollection("articoli", ({ data }) => {
    // In produzione mostra solo i non-draft, in dev mostra tutto
    if (import.meta.env.PROD) {
        return data.draft !== true;
    }
    return true;
});

// Filtra solo gli articoli della categoria "Stampa 3D"
const printArticles = allArticles
    .filter((article) => article.data.category === "Stampa 3D")
    .sort((a, b) => b.data.date.valueOf() - a.data.date.valueOf());
---

<Layout title="Laboratorio Stampa 3D">
    <div class="min-h-screen bg-paper">
        <Navigation />

        <main class="lg:ml-64 relative z-10">
            <!-- FAKE 404 View (Visible by default) -->
            <div id="content-404" class="block">
                <NotFoundHero />
            </div>

            <!-- REAL CONTENT (Hidden by default, shown via JS if logged in) -->
            <div id="content-protected" class="hidden">
                <!-- Header Section -->
                <header
                    class="bg-ink text-white p-12 md:p-20 relative overflow-hidden"
                >
                    <div class="max-w-4xl relative z-10">
                        <span
                            class="font-mono text-xs font-bold uppercase tracking-widest text-accent mb-4 block"
                        >
                            /// Additive Manufacturing Hub
                        </span>
                        <h1
                            class="font-sans font-black text-5xl md:text-7xl uppercase leading-none mb-6"
                        >
                            Stampa <span
                                class="text-transparent text-stroke-white"
                                >3D</span
                            >
                            <br />& Maker Zone
                        </h1>
                        <p
                            class="font-serif text-xl border-l-4 border-accent pl-6 max-w-2xl text-gray-300"
                        >
                            Dal riempimento a nido d'ape ai supporti organici.
                            News, trucchi e calibrazioni per trasformare il
                            filamento in realtà.
                        </p>
                    </div>

                    <!-- Abstract 3D Background Decoration -->
                    <div
                        class="absolute right-0 top-0 h-full w-1/2 opacity-10 pointer-events-none"
                        style="background-image: radial-gradient(circle at 50% 50%, #fff 2px, transparent 2.5px); background-size: 30px 30px;"
                    >
                    </div>
                </header>

                <!-- Warning for Offline Mode (Visible only to you effectively since it's unlinked) -->
                <div
                    class="bg-yellow-300 text-ink font-mono text-xs font-bold uppercase text-center py-2 border-b-4 border-ink"
                >
                    /// SEZIONE RISERVATA - VISIBILE SOLO AGLI AMMINISTRATORI
                    ///
                </div>

                <div class="p-6 md:p-12 max-w-7xl mx-auto">
                    {
                        printArticles.length > 0 ? (
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                                {printArticles.map((article) => (
                                    <article class="group bg-white border-4 border-ink shadow-neo relative hover:-translate-y-2 transition-transform duration-300 h-full flex flex-col">
                                        <div class="p-6 flex-grow">
                                            <div class="flex justify-between items-start mb-4">
                                                <span class="bg-accent text-ink text-xs font-mono font-bold uppercase px-2 py-1">
                                                    {article.data.category}
                                                </span>
                                                <span class="font-mono text-xs text-gray-500">
                                                    {article.data.date.toLocaleDateString(
                                                        "it-IT",
                                                        {
                                                            day: "numeric",
                                                            month: "short",
                                                            year: "numeric",
                                                        },
                                                    )}
                                                </span>
                                            </div>

                                            <h2 class="font-sans font-black text-2xl uppercase mb-3 leading-tight group-hover:underline decoration-accent decoration-4">
                                                <a
                                                    href={`/articoli/${article.slug}`}
                                                >
                                                    {article.data.title}
                                                </a>
                                            </h2>

                                            <p class="font-serif text-gray-600 line-clamp-3">
                                                {article.data.description}
                                            </p>
                                        </div>

                                        <div class="px-6 py-4 border-t-2 border-ink bg-gray-50 mt-auto">
                                            <a
                                                href={`/articoli/${article.slug}`}
                                                class="font-mono text-xs font-bold uppercase tracking-widest flex items-center gap-2 group-hover:gap-4 transition-all"
                                            >
                                                Leggi Articolo <span>→</span>
                                            </a>
                                        </div>
                                    </article>
                                ))}
                            </div>
                        ) : (
                            <div class="text-center py-20 border-4 border-dashed border-gray-300">
                                <h3 class="font-sans font-black text-3xl text-gray-400 uppercase mb-4">
                                    Nessun artefatto trovato
                                </h3>
                                <p class="font-serif text-gray-500 max-w-md mx-auto">
                                    L'estrusore è caldo ma il piatto è vuoto.
                                    Aggiungi il primo articolo con categoria
                                    "Stampa 3D".
                                </p>
                            </div>
                        )
                    }

                    <!-- Quick Guides Section -->
                    <div class="mt-20">
                        <h2
                            class="font-sans font-black text-4xl uppercase mb-8 flex items-center gap-4"
                        >
                            <span class="w-12 h-1 bg-ink"></span>
                            Risorse Rapide
                        </h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                            <div class="bg-black text-white p-8 shadow-neo-lg">
                                <h3
                                    class="font-mono text-accent text-xl font-bold mb-4"
                                >
                                    > PLA vs PETG
                                </h3>
                                <ul class="font-serif space-y-2 text-gray-300">
                                    <li>
                                        <strong class="text-white">PLA:</strong> Facile,
                                        estetico, non resiste al calore (>50°C).
                                    </li>
                                    <li>
                                        <strong class="text-white">PETG:</strong
                                        > Resistente, flessibile, ma stringa parecchio.
                                    </li>
                                    <li class="pt-4 text-sm italic opacity-70">
                                        Consiglio: Per i supporti smartphone in
                                        auto, usa sempre PETG o ASA. Il PLA si
                                        soglie al sole.
                                    </li>
                                </ul>
                            </div>
                            <div
                                class="bg-white border-4 border-ink p-8 shadow-neo-lg"
                            >
                                <h3
                                    class="font-mono text-ink text-xl font-bold mb-4"
                                >
                                    > Check Livellamento
                                </h3>
                                <p class="font-serif text-gray-600 mb-4">
                                    Il 90% dei problemi è il "First Layer". Se
                                    il primo strato non è perfetto, ferma tutto.
                                </p>
                                <a
                                    href="#"
                                    class="inline-block bg-ink text-white font-mono text-xs px-4 py-2 uppercase hover:bg-accent hover:text-ink transition-colors"
                                >
                                    Scarica STL Test
                                </a>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="mt-12">
                    <Footer />
                </div>
            </div>
        </main>
    </div>

    <script>
        // CLIENT-SIDE AUTH CHECK
        // If user is logged in via Netlify Identity, show content.
        // Otherwise, keep showing 404.

        function checkAuth() {
            if (
                window.netlifyIdentity &&
                window.netlifyIdentity.currentUser()
            ) {
                console.log("User authorized. Showing content.");
                document.getElementById("content-404")?.classList.add("hidden");
                document
                    .getElementById("content-protected")
                    ?.classList.remove("hidden");
            } else {
                console.log("User not logged in. Showing 404.");
                // Ensure 404 is visible (default)
            }
        }

        // Initialize check
        if (window.netlifyIdentity) {
            window.netlifyIdentity.on("init", checkAuth);
            window.netlifyIdentity.on("login", checkAuth);
            window.netlifyIdentity.on("logout", () => {
                window.location.reload();
            });
            // First check immediately in case init already fired
            checkAuth();
        } else {
            // Fallback if script hasn't loaded yet? Usually layout loads it in head.
            document.addEventListener("DOMContentLoaded", checkAuth);
        }
    </script>
</Layout>
